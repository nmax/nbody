{"version":3,"sources":["nbody/bodies.js","nbody/body.js","nbody/helpers.js","nbody/index.js","nbody/integrator.js","nbody/timer.js"],"sourcesContent":["define('nbody/bodies', ['exports', 'nbody/body'], function (exports, _nbodyBody) {\n  'use strict';\n\n  exports['default'] = bodiesFactory;\n  var BodiesProto = {\n    createBody: function createBody(bodyProps) {\n      var newBody = (0, _nbodyBody['default'])(bodyProps);\n      this._bodies.push(newBody);\n      return newBody;\n    },\n\n    removeBody: function removeBody(body) {\n      for (var i = 0, l = this._bodies.length; i < l; i += 1) {\n        if (this._bodies[i] === body) {\n          var removed = this._bodies.splice(i, 1);\n          return removed[0];\n        }\n      }\n    },\n\n    getBodies: function getBodies() {\n      return this._bodies;\n    },\n\n    resetBodies: function resetBodies() {\n      this._bodies = [];\n      return this._bodies;\n    }\n  };\n\n  exports.BodiesProto = BodiesProto;\n\n  function bodiesFactory() {\n    var bodies = Object.create(BodiesProto);\n    bodies._bodies = [];\n    return bodies;\n  }\n});","define('nbody/body', ['exports', 'nbody/helpers'], function (exports, _nbodyHelpers) {\n  'use strict';\n\n  exports['default'] = bodyFactory;\n  var G = 6.674e-11; //  N⋅m²/kg²\n\n  var State = {\n    x: undefined,\n    dx: undefined,\n\n    create: function create(x, dx) {\n      var s = Object.create(State);\n      s.x = x;\n      s.dx = dx;\n      return s;\n    }\n  };\n\n  var BodyPrototype = {\n    applyForces: true,\n    state: undefined,\n\n    _forces: undefined,\n\n    mass: undefined,\n    radius: undefined,\n\n    computeAcceleration: function computeAcceleration(bodies, state) {\n      var _this = this;\n\n      if (!this.applyForces) {\n        return this._forces; // no force, no acceleration\n      }\n\n      this._forces[0] = 0;\n      this._forces[1] = 0;\n      this._forces[2] = 0;\n\n      bodies.forEach(function (otherBody) {\n        if (this !== otherBody) {\n          var dist = this.computeDistance(otherBody, state);\n          var heading = this.computeHeading(otherBody, state, dist);\n          var gravity = this.computeGravity(otherBody, dist);\n\n          if (dist > this.radius + otherBody.radius) {\n            this._forces[0] += heading[0] * gravity;\n            this._forces[1] += heading[1] * gravity;\n            this._forces[2] += heading[2] * gravity;\n          }\n        }\n      }, this);\n\n      return this._forces.map(function (force) {\n        return force / _this.mass;\n      });\n    },\n\n    initialDerivative: function initialDerivative(bodies) {\n      var acceleration = this.computeAcceleration(bodies, this.state);\n      return State.create(this.state.dx, acceleration);\n    },\n\n    nextDerivative: function nextDerivative(bodies, initialState, derivative, t, dt) {\n      var nextState = State.create([initialState.x[0] + derivative.dx[0] * dt, initialState.x[1] + derivative.dx[1] * dt, initialState.x[2] + derivative.dx[2] * dt], [initialState.dx[0] + derivative.dx[0] * dt, initialState.dx[1] + derivative.dx[1] * dt, initialState.dx[2] + derivative.dx[2] * dt]);\n\n      var acceleration = this.computeAcceleration(bodies, nextState, t + dt);\n      return State.create(nextState.dx, acceleration);\n    },\n\n    computeGravity: function computeGravity(otherBody, distance) {\n      return G * this.mass * otherBody.mass / (distance * distance);\n    },\n\n    computeDistance: function computeDistance(otherBody, state) {\n      var xdist = otherBody.state.x[0] - state.x[0];\n      var ydist = otherBody.state.x[1] - state.x[1];\n      var zdist = otherBody.state.x[2] - state.x[2];\n      return Math.sqrt(xdist * xdist + ydist * ydist + zdist * zdist);\n    },\n\n    computeHeading: function computeHeading(otherBody, state, distance) {\n      return [(otherBody.state.x[0] - state.x[0]) / distance, (otherBody.state.x[1] - state.x[1]) / distance, (otherBody.state.x[2] - state.x[2]) / distance];\n    }\n\n  };\n\n  exports.BodyPrototype = BodyPrototype;\n  function setCircularSpeed(body, barycenter, virtualCentralMass) {\n    var center = State.create(barycenter, [0, 0, 0]);\n    var dist = BodyPrototype.computeDistance(body, center);\n    var heading = BodyPrototype.computeHeading(body, center, dist);\n    var speed = Math.sqrt(G * (body.mass + virtualCentralMass) / dist);\n    if (dist !== 0) {\n      body.state.dx[0] = heading[1] * speed;\n      body.state.dx[1] = -heading[0] * speed;\n    }\n  }\n\n  function bodyFactory(props) {\n    var body = Object.create(BodyPrototype);\n    var pos = props.position || [0, 0, 0];\n    var vel = props.velocity || [0, 0, 0];\n    body.state = State.create(pos, vel);\n\n    (0, _nbodyHelpers.assign)(body, {\n      radius: props.radius || 0,\n      mass: props.mass || 1,\n      _forces: [0, 0, 0]\n    });\n\n    if (props.isStatic) {\n      body.applyForces = false;\n    }\n\n    if (props.startCircular) {\n      var bPos = props.startCircular.center;\n      var bMass = props.startCircular.mass;\n      setCircularSpeed(body, bPos, bMass);\n    }\n\n    return body;\n  }\n});","define(\"nbody/helpers\", [\"exports\"], function (exports) {\n  \"use strict\";\n\n  var _slice = Array.prototype.slice;\n  exports.assign = assign;\n\n  function _toArray(arr) { return Array.isArray(arr) ? arr : Array.from(arr); }\n\n  var isEnumerableProp = Object.prototype.isEnumerable;\n  var hasOwnProperty = Object.prototype.hasOwnProperty;\n\n  function assign() {\n    var args = [].concat(_slice.call(arguments));\n    if (Object.assign) {\n      return Object.assign.apply(Object, args);\n    } else {\n      var _ret = (function () {\n        var _args = _toArray(args);\n\n        var target = _args[0];\n\n        var sources = _args.slice(1);\n\n        sources.forEach(function (source) {\n          var keys = Object.keys(source);\n\n          keys.forEach(function (key) {\n            if (hasOwnProperty.call(source, key)) {\n              target[key] = source[key];\n            }\n          });\n\n          if (Object.getOwnPropertySymbols) {\n            var symbols = Object.getOwnPropertySymbols(source);\n            symbols.forEach(function (symbol) {\n              if (isEnumerableProp.call(source, symbol)) {\n                target[symbol] = source[symbol];\n              }\n            });\n          }\n        });\n\n        return {\n          v: target\n        };\n      })();\n\n      if (typeof _ret === \"object\") return _ret.v;\n    }\n  }\n});","define('nbody', ['exports', 'nbody/bodies', 'nbody/timer', 'nbody/integrator'], function (exports, _nbodyBodies, _nbodyTimer, _nbodyIntegrator) {\n  'use strict';\n\n  exports['default'] = createNBody;\n  exports.registerGlobal = registerGlobal;\n\n  function createNBody() {\n    var sim = Object.create(null);\n    sim.bodies = (0, _nbodyBodies['default'])();\n    sim.timer = (0, _nbodyTimer['default'])();\n    sim.step = (0, _nbodyIntegrator['default'])(sim.bodies, sim.timer);\n    return sim;\n  }\n\n  function registerGlobal(window) {\n    window.nbody = createNBody;\n  }\n});","define('nbody/integrator', ['exports'], function (exports) {\n  'use strict';\n\n  exports['default'] = integratorFactory;\n  function integrateEuler(body, bodies, dt) {\n    var a = body.computeAcceleration(bodies, body.state);\n\n    body.state.dx[0] += a[0] * dt;\n    body.state.dx[1] += a[1] * dt;\n    body.state.dx[2] += a[2] * dt;\n\n    body.state.x[0] += body.state.dx[0] * dt;\n    body.state.x[1] += body.state.dx[1] * dt;\n    body.state.x[2] += body.state.dx[2] * dt;\n  }\n\n  function integrateRK4(body, bodies, t, dt) {\n    var initialState = body.state;\n    var d1 = body.initialDerivative(bodies);\n    var d2 = body.nextDerivative(bodies, initialState, d1, t, dt * 0.5);\n    var d3 = body.nextDerivative(bodies, initialState, d2, t, dt * 0.5);\n    var d4 = body.nextDerivative(bodies, initialState, d3, t, dt);\n\n    var vel0 = 1 / 6 * (d1.x[0] + 2 * (d2.x[0] + d3.x[0]) + d4.x[0]) * dt;\n    var vel1 = 1 / 6 * (d1.x[1] + 2 * (d2.x[1] + d3.x[1]) + d4.x[1]) * dt;\n    var vel2 = 1 / 6 * (d1.x[2] + 2 * (d2.x[2] + d3.x[2]) + d4.x[2]) * dt;\n\n    var acc0 = 1 / 6 * (d1.dx[0] + 2 * (d2.dx[0] + d3.dx[0]) + d4.dx[0]) * dt;\n    var acc1 = 1 / 6 * (d1.dx[1] + 2 * (d2.dx[1] + d3.dx[1]) + d4.dx[1]) * dt;\n    var acc2 = 1 / 6 * (d1.dx[2] + 2 * (d2.dx[2] + d3.dx[2]) + d4.dx[2]) * dt;\n\n    body.state.x[0] += vel0;\n    body.state.x[1] += vel1;\n    body.state.x[2] += vel2;\n\n    body.state.dx[0] += acc0;\n    body.state.dx[1] += acc1;\n    body.state.dx[2] += acc2;\n  }\n\n  function moveBodies(type, bodies, t, dt) {\n    var steps = 4;\n\n    bodies.forEach(function (body) {\n      var step = 0;\n      for (; step < steps; step += 1) {\n        if (type === 'euler') {\n          integrateEuler(body, bodies, dt / steps);\n        }\n\n        if (type === 'rk4') {\n          integrateRK4(body, bodies, t, dt / steps);\n        }\n      }\n    });\n  }\n\n  function integratorFactory(bodies, timer) {\n    var type = arguments.length <= 2 || arguments[2] === undefined ? 'rk4' : arguments[2];\n\n    return function integrate() {\n      moveBodies(type, bodies.getBodies(), timer.time, timer.dt);\n    };\n  }\n});","define(\"nbody/timer\", [\"exports\"], function (exports) {\n  \"use strict\";\n\n  exports[\"default\"] = timerFactory;\n  var SECOND = 1000;\n  var MINUTE = SECOND * 60;\n  var HOUR = MINUTE * 60;\n  var DAY = HOUR * 24;\n  var MONTH = DAY * 31;\n  var YEAR = DAY * 365;\n\n  var Timer = {\n    units: Object.freeze({\n      SECOND: SECOND,\n      MINUTE: MINUTE,\n      HOUR: HOUR,\n      DAY: DAY,\n      MONTH: MONTH,\n      YEAR: YEAR\n    }),\n\n    time: 0,\n    dt: 5 * MINUTE,\n\n    advance: function advance(increment) {\n      this.time += increment || this.dt;\n    }\n  };\n\n  function timerFactory() {\n    return Object.create(Timer);\n  }\n});"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACzHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AChBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC/DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;","file":"nbody.js"}